// test_cmac.c 
// Test program for CMAC MAC computation. 

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

#include "auth.h"

/* ----------------------------------------------------------------------------
	Local Prototypes
*/

static void test_0(void);
static void test_1(void);
static void test_2(void);
static void test_3(void);

static void hexdump(uint8_t *bytes, size_t len);

/* ----------------------------------------------------------------------------
	Main
*/

int main(void) {
	test_0();
	test_1();
	test_2();
	test_3();

	return 0;
}

// test zero-length message
static void test_0(void) {
	uint8_t key[] = { 0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6, 0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c };

	uint8_t msg[] = { 0x6b };
	uint8_t tag[16];

	auth_cmac_gen(tag, msg, 0, key);

	printf("Example 1: len = 0\n");
	puts("KEY:");
	hexdump(key, 16);
	puts("M:");
	puts("<empty string>");
	puts("CMAC TAG:");
	hexdump(tag, 16);
	putchar('\n');
}

static void test_1(void) {
	uint8_t key[] = { 0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6, 0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c };

	uint8_t msg[] = { 0x6b, 0xc1, 0xbe, 0xe2, 0x2e, 0x40, 0x9f, 0x96, 0xe9, 0x3d, 0x7e, 0x11, 0x73, 0x93, 0x17, 0x2a };
	uint8_t tag[16];

	auth_cmac_gen(tag, msg, 16, key);

	printf("Example 2: len = 16\n");
	puts("KEY:");
	hexdump(key, 16);
	puts("M:");
	hexdump(msg, 16);
	puts("CMAC TAG:");
	hexdump(tag, 16);
	putchar('\n');
}

static void test_2(void) {
	uint8_t key[] = { 0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6, 0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c };
	
	uint8_t msg[] = {
		0x6b, 0xc1, 0xbe, 0xe2, 0x2e, 0x40, 0x9f, 0x96, 0xe9, 0x3d, 0x7e, 0x11, 0x73, 0x93, 0x17, 0x2a,
		0xae, 0x2d, 0x8a, 0x57, 0x1e, 0x03, 0xac, 0x9c, 0x9e, 0xb7, 0x6f, 0xac, 0x45, 0xaf, 0x8e, 0x51,
		0x30, 0xc8, 0x1c, 0x46, 0xa3, 0x5c, 0xe4, 0x11
	};
	uint8_t tag[16];

	auth_cmac_gen(tag, msg, 40, key);

	printf("Example 3: len = 40\n");
	puts("KEY:");
	hexdump(key, 16);
	puts("M:");
	hexdump(msg, 16);
	hexdump(msg+16, 16);
	hexdump(msg+32, 8);
	puts("CMAC TAG:");
	hexdump(tag, 16);
	putchar('\n');
}

static void test_3(void) {
	uint8_t key[] = { 0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6, 0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c };
	
	uint8_t msg[] = {
		0x6b, 0xc1, 0xbe, 0xe2, 0x2e, 0x40, 0x9f, 0x96, 0xe9, 0x3d, 0x7e, 0x11, 0x73, 0x93, 0x17, 0x2a,
		0xae, 0x2d, 0x8a, 0x57, 0x1e, 0x03, 0xac, 0x9c, 0x9e, 0xb7, 0x6f, 0xac, 0x45, 0xaf, 0x8e, 0x51,
		0x30, 0xc8, 0x1c, 0x46, 0xa3, 0x5c, 0xe4, 0x11, 0xe5, 0xfb, 0xc1, 0x19, 0x1a, 0x0a, 0x52, 0xef,
		0xf6, 0x9f, 0x24, 0x45, 0xdf, 0x4f, 0x9b, 0x17, 0xad, 0x2b, 0x41, 0x7b, 0xe6, 0x6c, 0x37, 0x10,
		0x51, 0xf0, 0xbe, 0xbf, 0x7e, 0x3b, 0x9d, 0x92, 0xfc, 0x49, 0x74, 0x17, 0x79, 0x36, 0x3c, 0xfe
	};
	uint8_t tag[16];

	auth_cmac_gen(tag, msg, 64, key);

	printf("Example 4: len = 64\n");
	puts("KEY:");
	hexdump(key, 16);
	puts("M:");
	hexdump(msg, 16);
	hexdump(msg+16, 16);
	hexdump(msg+32, 16);
	hexdump(msg+48, 16);
	puts("CMAC TAG:");
	hexdump(tag, 16);
	putchar('\n');
}

/* ----------------------------------------------------------------------------
	Local Functions
*/

// print hexadecimal-formatted bytes to stdout
static void hexdump(uint8_t *bytes, size_t len) {
	for (size_t i = 0; i < len; i++) 
		printf("%02x ", bytes[i]);
	putchar('\n');
}
